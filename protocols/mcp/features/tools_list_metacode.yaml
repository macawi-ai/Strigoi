# Feature Metacode: tools/list
# This describes WHAT to test, not HOW
# Strigoi interprets this into executable code

feature:
  id: mcp_tools_list
  contract_ref: "MCP-2025-03-26#definitions.ListToolsRequest"
  risk_level: LOW
  white_hat_permitted: YES

operation:
  action: SEND_REQUEST
  protocol: JSON_RPC_2.0
  method: "tools/list"
  
  parameters:
    optional:
      - name: cursor
        type: STRING
        purpose: PAGINATION
        
  constraints:
    rate_limit: 
      max: 10
      window: MINUTE
    timeout: 5_SECONDS
    retry: FORBIDDEN

validation_rules:
  
  - rule: MUST_BE_VALID_JSONRPC
    check: 
      field: response.jsonrpc
      equals: "2.0"
      
  - rule: MUST_CONTAIN_TOOLS_ARRAY
    check:
      field: response.result.tools
      type: ARRAY
      
  - rule: EACH_TOOL_MUST_HAVE_SCHEMA
    foreach: response.result.tools
    check:
      required_fields:
        - name: STRING
        - inputSchema: OBJECT
        
  - rule: NO_INTERNAL_TOOLS_EXPOSED
    foreach: response.result.tools
    check:
      field: name
      must_not_match:
        - pattern: "admin*"
        - pattern: "internal*"
        - pattern: "debug*"
        - pattern: "__*"
    severity: SECURITY_FINDING
    
  - rule: RESPONSE_TIME_REASONABLE
    check:
      metric: response_time
      less_than: 5_SECONDS
      
  - rule: ID_MUST_MATCH
    check:
      field: response.id
      equals: request.id

behavior_constraints:
  
  - constraint: ENUMERATION_ONLY
    forbidden_actions:
      - CALL_DISCOVERED_TOOLS
      - MODIFY_PARAMETERS
      - FUZZ_INPUTS
      
  - constraint: RESPECT_PAGINATION
    required_actions:
      - IF_CURSOR_PROVIDED: USE_IT
      - IF_NO_MORE_PAGES: STOP
      
  - constraint: LOG_EVERYTHING
    required_data:
      - timestamp
      - target
      - request_sent
      - response_received
      - validation_results

test_sequence:
  1_PREPARE:
    - GENERATE_REQUEST_ID
    - CHECK_RATE_LIMIT
    
  2_EXECUTE:
    - BUILD_JSONRPC_REQUEST
    - SEND_WITH_TIMEOUT
    - CAPTURE_RESPONSE
    
  3_VALIDATE:
    - APPLY_ALL_RULES
    - RECORD_FINDINGS
    
  4_REPORT:
    - SUMMARY: PASS | FAIL | SECURITY_FINDINGS
    - DETAILS: ALL_VALIDATION_RESULTS
    - EVIDENCE: REQUEST_RESPONSE_PAIR

# Strigoi's interpreter converts this metacode into:
# - Go code for go-strigoi
# - Python code for py-strigoi  
# - Rust code for rust-strigoi
# The metacode remains constant across implementations